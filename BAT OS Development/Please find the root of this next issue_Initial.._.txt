The root of this failure is that the

knowledge_catalog_obj is being created with a standard zope.index.text.TextIndex1. This object internally contains a non-serializable threading lock (

_thread.RLock), which ZODB cannot save to the database, causing the transaction to fail on commit2.

Your script already defines the correct solution—the PersistentTextIndex class—but it is not being used. You only need to change one line to instantiate this correct, persistent-aware class.

The Fix

In the _incarnate_subsystems method, you must replace the original TextIndex() with your new PersistentTextIndex().

Line to Replace:

Python

text_index=TextIndex(),


Replacement Line:

Python

text_index=PersistentTextIndex(),
